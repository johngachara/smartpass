<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.unpkg.com/react@16.7.0/umd/react.production.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous">
    <title>Upload Photo</title>
</head>

<body>
    <div class="px-4 pt-5 my-5 text-center border-bottom">
        <h1 class="display-4 fw-bold text-body-emphasis">PHOTO REGISTRATION</h1>
        <div class="col-lg-6 mx-auto">
            <p id="message" class="lead mb-4">Upload a clear photo of your face.</p>
            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mb-5">
                <button id="captureButton" onclick="capturePhoto()" class="btn btn-primary btn-lg px-4 me-sm-3">Take
                    Photo</button>
                <button id="recaptureButton" onclick="recapture()"
                    class="btn btn-secondary btn-lg px-4 d-none">Recapture</button>
                <button id="uploadButton" onclick="sendPhoto()"
                    class="btn btn-secondary btn-lg px-4 d-none">Upload This Photo</button>
                <a type="button" id="complete_reg" href="{% url 'complete' User.id %}"
                    class="btn btn-primary btn-lg px-4 me-sm-3 d-none">Complete Registration</a>
            </div>
            <div id="user-id" data-user-id="{{ User.id }}"></div>
            <script>
                // Define JavaScript variables
                const recaptureButton = document.getElementById('recaptureButton');
                const uploadButton = document.getElementById('uploadButton');
                const completeRegButton = document.getElementById('complete_reg');

                function sendPhoto() {
                    recaptureButton.classList.add('d-none');
                    uploadButton.classList.add('d-none');
                    completeRegButton.classList.remove('d-none');

                    // Get the image data from the img element
                    const imgElement = document.querySelector('.img-fluid');
                    const imageDataUrl = imgElement.src;

                    // Check if there is a captured image
                    if (!imageDataUrl) {
                        console.error('No captured image to send.');
                        return;
                    }

                    const base64Data = imageDataUrl.split(',')[1];
                    const binaryData = atob(base64Data);
                    const arrayBuffer = new ArrayBuffer(binaryData.length);
                    const uint8Array = new Uint8Array(arrayBuffer);
                    for (let i = 0; i < binaryData.length; i++) {
                        uint8Array[i] = binaryData.charCodeAt(i);
                    }
                    const blob = new Blob([uint8Array], {
                        type: 'image/png'
                    });
                    const formData = new FormData();
                    formData.append('photo', blob, '{{ User.username }}.png');

                    // Get the user ID from the data attribute
                    const userId = document.getElementById('user-id').getAttribute('data-user-id');

                    // Send a POST request to your Django API endpoint
                    fetch(`https://gachara.pythonanywhere.com/api/photo/${userId}/`, {
                            method: 'POST',
                        headers:{
                               "Content-Type": "application/json",
                        },
                            body: formData,
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response; // Adjust this based on your API response format
                        })
                        .then(data => {
                            // Handle the success response
                            console.log(data);
                        })
                        .catch(error => {
                            // Handle errors
                            console.error('Error:', error);
                        });
                }

            </script>
        </div>

        <div class="container px-5">
            <img src="" class="img-fluid border rounded-3 shadow-lg mb-4" alt="Your photo will appear here" width="500"
                height="500" loading="lazy">
        </div>

        <video id="camera" width="640" height="480" autoplay></video>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const video = document.getElementById('camera');
                const captureButton = document.getElementById('captureButton');
                const recaptureButton = document.getElementById('recaptureButton');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let recapture = false;

                function initCamera() {
                    navigator.mediaDevices.getUserMedia({
                            video: true
                        })
                        .then((stream) => {
                            video.srcObject = stream;
                        })
                        .catch((error) => {
                            console.error('Error accessing camera:', error);
                        });
                }

                initCamera();

                window.capturePhoto = function () {
                    captureButton.disabled = true;
                    captureButton.classList.add('d-none');
                    uploadButton.classList.remove('d-none');
                    completeRegButton.classList.add('d-none');
                    message.innerText = 'Ensure Your photo is clearly visible,if not press the recapture button to take another photo';

                    recaptureButton.classList.remove('d-none');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    video.style.display = 'none';

                    const imageDataUrl = canvas.toDataURL('image/png');
                    const existingImg = document.querySelector('.img-fluid');
                    existingImg.src = imageDataUrl;

                    recapture = true;
                };

                window.recapture = function () {
                    captureButton.disabled = false;
                    captureButton.classList.remove('d-none');
                    uploadButton.classList.add('d-none');
                    message.innerText = 'Upload a Clear photo of your face';
                    completeRegButton.classList.add('d-none');
                    recaptureButton.classList.add('d-none');

                    const existingImg = document.querySelector('.img-fluid');
                    existingImg.src = '';

                    recapture = false;

                    initCamera();
                                     video.style.display = 'flex';
                    video.style.height = 'auto';
                    video.style.margin = '0 auto';
                };
            });
        </script>
    </div>
</body>

</html>

